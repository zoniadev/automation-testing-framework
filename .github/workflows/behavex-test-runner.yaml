name: BehaveX Hardcoded Test

on:
  workflow_dispatch: # Manual trigger
  push:              # Auto-trigger on push so it appears in Actions tab
    branches:
      - '**'         # Run on any branch where this file exists

jobs:
  test-behavex:
    runs-on: ubuntu-latest
    env:
      # --- HARDCODED CONFIGURATION ---
      DEVICE: 'desktop'
      ENVIRONMENT: 'staging'
      TAGS: '@unbroken_live'
      PARALLEL_PROCESSES: '2'
      REPORT_SCOPE: 'behavex-test' # Isolated scope
      REPORT_NAME: 'parallel-validation'
      REPORT_BASE_URL: https://zoniadev.github.io/automation-testing-framework
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install behavex
          npm install -g allure-commandline --save-dev

      - name: Install missing libraries
        run: |
          sudo apt-get update
          sudo apt-get install -y libwoff1 libevent-2.1-7 libopus0 libgstreamer-plugins-base1.0-0 libgstreamer1.0-0 libharfbuzz-icu0 libhyphen0 libmanette-0.2-0 libflite1 libgles2

      - name: Install Chromium
        run: playwright install chromium

      - name: Run BehaveX (Parallel)
        run: |
          set -euo pipefail
          
          # Raw output from BehaveX
          BEHAVEX_OUTPUT="behavex_output"
          mkdir -p "$BEHAVEX_OUTPUT"
          
          echo "ðŸš€ Running BehaveX with $PARALLEL_PROCESSES workers..."
          
          # FIX: Force short temp path to avoid "AF_UNIX path too long" error
          export TMPDIR=/tmp
          
          # Run BehaveX
          behavex -t $TAGS \
            --parallel-processes $PARALLEL_PROCESSES \
            --parallel-scheme scenario \
            -D headless=True \
            -D device=$DEVICE \
            -D env=$ENVIRONMENT \
            -o "$BEHAVEX_OUTPUT" \
            --no-capture \
            --no-capture-stderr || true
            
          # --- PREPARE ALLURE INPUT ---
          # BehaveX creates nested folders. We need to flatten all JSON/PNG files into one folder for Allure.
          ALLURE_INPUT="allure-results/$REPORT_SCOPE"
          mkdir -p "$ALLURE_INPUT"
          
          echo "ðŸ“‚ Flattening results for Allure..."
          
          # Find all result files and copy them to the clean input dir
          find "$BEHAVEX_OUTPUT" -name "*.json" -exec cp {} "$ALLURE_INPUT/" \;
          find "$BEHAVEX_OUTPUT" -name "*.png" -exec cp {} "$ALLURE_INPUT/" \;
          find "$BEHAVEX_OUTPUT" -name "*.webm" -exec cp {} "$ALLURE_INPUT/" \;
          find "$BEHAVEX_OUTPUT" -name "environment.properties" -exec cp {} "$ALLURE_INPUT/" \;
          
          echo "âœ… Results prepared in $ALLURE_INPUT"
          ls -l "$ALLURE_INPUT" | head -n 10
        shell: bash

      - name: Copy environment properties
        if: always()
        run: |
          # Ensure environment.properties is present (if not already copied by find)
          if [ -f "allure-results/environment.properties" ]; then
            cp "allure-results/environment.properties" "allure-results/$REPORT_SCOPE/environment.properties"
          fi

      # --- REPORT GENERATION (Standard Logic) ---
      
      - name: Load history
        uses: actions/checkout@v3
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Prepare Allure workspace
        if: always()
        run: |
          mkdir -p allure-history
          if [ -d gh-pages ]; then
            rsync -a --exclude '.git' gh-pages/ allure-history/
          fi

      - name: Generate Report
        if: always()
        run: |
          # Simple sequence generator for this test
          HISTORY_ROOT="allure-history/$REPORT_SCOPE/$REPORT_NAME"
          mkdir -p "$HISTORY_ROOT"
          
          # Calculate next sequence
          LAST_SEQ=$(ls "$HISTORY_ROOT" | grep -E '^[0-9]+$' | sort -n | tail -1 || echo "0")
          NEXT_SEQ=$((LAST_SEQ + 1))
          echo "REPORT_SEQUENCE=$NEXT_SEQ" >> "$GITHUB_ENV"
          
          OUTPUT_DIR="$HISTORY_ROOT/$NEXT_SEQ"
          RESULTS_DIR="allure-results/$REPORT_SCOPE"
          
          echo "ðŸ“Š Generating report from $RESULTS_DIR..."
          
          # Generate
          allure generate "$RESULTS_DIR" --clean -o "$OUTPUT_DIR"
          
          # Update 'latest'
          rm -rf "$HISTORY_ROOT/latest"
          cp -R "$OUTPUT_DIR" "$HISTORY_ROOT/latest"
          
          # Create redirect
          echo "<!DOCTYPE html><html><head><meta http-equiv=\"refresh\" content=\"0; url=./$NEXT_SEQ/\"></head></html>" > "$HISTORY_ROOT/index.html"
        shell: bash

      - name: Publish to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history

      - name: Post Link
        if: always()
        uses: Sibz/github-status-action@v1
        with:
          authToken: ${{ secrets.GITHUB_TOKEN }}
          context: 'BehaveX Report'
          state: 'success'
          sha: ${{ github.sha }}
          target_url: ${{ env.REPORT_BASE_URL }}/${{ env.REPORT_SCOPE }}/${{ env.REPORT_NAME }}/${{ env.REPORT_SEQUENCE }}
